<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>🌿 온마음 성장일기 · 학생용 MVP</title>
<style>
body{font-family:"Noto Sans KR",sans-serif;background:#f5f6fa;margin:0}
.card{background:white;padding:20px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.1);width:400px;max-width:90%;margin:0 auto;text-align:center}
h1{font-size:22px;margin:10px 0}
input,button,textarea,select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{cursor:pointer;background:#2563eb;color:white;font-weight:600;border:none}
button:hover{background:#1d4ed8}
.ghost{background:#e5e7eb;color:black}
.small{font-size:13px;color:gray}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:12px}
.day{background:#fff;border:1px solid #ddd;border-radius:8px;aspect-ratio:1/1;position:relative;cursor:pointer}
.day .num{position:absolute;top:4px;right:6px;font-size:12px;color:#555}
.day .tag{position:absolute;left:4px;bottom:4px;font-size:10px;background:#fff8d1;border-radius:4px;padding:2px 3px;color:#222;border:1px solid #fde68a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.star{position:absolute;top:4px;left:4px;color:#f59e0b;font-size:12px}
.today{outline:2px solid #2563eb}
.grid{display:grid;grid-template-columns:340px 1fr;gap:12px;max-width:900px;margin:20px auto}
textarea{resize:none;height:90px}
.prev{font-size:12px;color:#555;background:#f9fafb;border:1px solid #e5e7eb}
.divider{height:1px;background:#e5e7eb;margin:10px 0}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

// 🔹 Firebase 설정
const firebaseConfig={
 apiKey:"AIzaSyCUvpi0A00lc9t4Aamo6jCL5ZeKSppPmVM",
 authDomain:"haru-dc490.firebaseapp.com",
 databaseURL:"https://haru-dc490-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"haru-dc490",
 storageBucket:"haru-dc490.appspot.com",
 messagingSenderId:"1062975092523",
 appId:"1:1062975092523:web:3750d0e5722cae7767b76e",
 measurementId:"G-6VVS4MSJBT"
};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

// 🔹 특별한 날 일부 (예시 3개만 테스트용)
const QUESTIONS={
 "03-02":{title:"3월 2일 · 개학",questions:{
  low:["여러분은 '개학'하면 어떤 것이 떠오르나요?","개학 전날 우리는 어떤 마음을 느낄 수 있을까요?","우리는 개학날 느끼는 여러가지 마음을 누구와 말할 수 있을까요?"],
  mid:["새로운 친구를 사귈 때 어떤 감정을 느끼나요?","개학을 앞두고 가장 걱정되는 것은 무엇인가요?","친구의 마음을 알아차리는 방법은 어떤 게 있을까요?"],
  high:["처음 만난 친구에게 어떻게 인사하면 좋을까요?","먼저 다가가는 것이 어려울 때는 어떻게 하는 것이 좋을까요?","친구를 사귀기 위한 여러분의 방법은 무엇인가요?"]
 }},
 "03-20":{title:"3월 20일 · 행복의 날",questions:{
  low:["여러분이 살면서 가장 행복했던 날은 언제인가요?","나는 어떤 순간에 행복하다고 느끼나요?","행복할 때 내 얼굴은 어떤 표정일까요?"],
  mid:["나에게 '진짜 행복'이란 무엇인가요?","최근 언제 가장 행복했나요?","친구의 행복을 위해 내가 해줄 수 있는 건 무엇일까요?"],
  high:["사람들마다 행복한 순간은 같을까요, 다를까요?","누군가를 행복하게 해준 적이 있나요?","행복을 함께 나누는 것은 어떻게 다를까요?"]
 }},
 "10-10":{title:"10월 10일 · 정신건강의 날",questions:{
  low:["오늘 여러분의 마음 날씨는 어떤가요?","마음 날씨가 흐린 날 우리는 무엇을 할 수 있을까요?","내 마음에게 해주고 싶은 말이 있다면?"],
  mid:["오늘 나의 감정을 색깔로 표현한다면?","마음이 힘들 때 도와줄 사람은?","기분이 좋아지는 나만의 방법은?"],
  high:["오늘 나의 감정을 색깔로 표현한다면?","마음을 건강하게 유지하는 건 왜 중요할까요?","여러분은 어떤 노력을 하나요?"]
 }}
};

// 학년군 구분
function band(n){n=Number(n||1);if(n<=2)return'low';if(n<=4)return'mid';return'high';}

// DOM 로드 후 실행
window.addEventListener("DOMContentLoaded",()=>{
 const loginView=document.getElementById("loginView");
 const mainView=document.getElementById("mainView");
 const loginBtn=document.getElementById("loginBtn");
 const signupBtn=document.getElementById("signupBtn");
 const logoutBtn=document.getElementById("logoutBtn");
 const yearSel=document.getElementById("yearSel");
 const monthSel=document.getElementById("monthSel");
 const gradeSel=document.getElementById("gradeSel");
 const calEl=document.getElementById("calendar");
 const qBox=document.getElementById("qBox");
 const saveBtn=document.getElementById("saveBtn");
 const qTitle=document.getElementById("qTitle");

 let viewYear=new Date().getFullYear();
 let viewMonth=new Date().getMonth();

 // 로그인
 signupBtn.onclick=async()=>{
  const id=document.getElementById("userid").value.trim();
  const pw=document.getElementById("password").value.trim();
  if(!id||!pw)return alert("입력!");
  const email=`${id}@id.onmaum`;
  try{await createUserWithEmailAndPassword(auth,email,pw);alert("회원가입 성공");}
  catch(e){alert(e.message);}
 };
 loginBtn.onclick=async()=>{
  const id=document.getElementById("userid").value.trim();
  const pw=document.getElementById("password").value.trim();
  if(!id||!pw)return alert("입력!");
  const email=`${id}@id.onmaum`;
  try{await signInWithEmailAndPassword(auth,email,pw);
    loginView.style.display="none";mainView.style.display="block";
    renderCal();
  }catch(e){alert(e.message);}
 };
 logoutBtn.onclick=async()=>{await signOut(auth);mainView.style.display="none";loginView.style.display="block";};

 // 셀렉트 구성
 for(let y=2024;y<=2026;y++){const o=document.createElement("option");o.value=y;o.textContent=y;yearSel.appendChild(o);}
 yearSel.value=viewYear;
 for(let m=1;m<=12;m++){const o=document.createElement("option");o.value=m-1;o.textContent=m;monthSel.appendChild(o);}
 monthSel.value=viewMonth;

 yearSel.onchange=()=>{viewYear=Number(yearSel.value);renderCal();}
 monthSel.onchange=()=>{viewMonth=Number(monthSel.value);renderCal();}

 function renderCal(){
  calEl.innerHTML="";
  const first=new Date(viewYear,viewMonth,1);
  const last=new Date(viewYear,viewMonth+1,0);
  const start=first.getDay();
  for(let i=0;i<start;i++){calEl.appendChild(document.createElement("div"));}
  for(let d=1;d<=last.getDate();d++){
   const cell=document.createElement("div");cell.className="day";
   const key=`${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
   if(QUESTIONS[key]){
    const s=document.createElement("div");s.className="star";s.textContent="★";cell.appendChild(s);
    const tag=document.createElement("div");tag.className="tag";tag.textContent=QUESTIONS[key].title.split("·")[1];cell.appendChild(tag);
   }
   const num=document.createElement("div");num.className="num";num.textContent=d;cell.appendChild(num);
   if(viewYear===new Date().getFullYear()&&viewMonth===new Date().getMonth()&&d===new Date().getDate())cell.classList.add("today");
   cell.onclick=()=>openDay(key);
   calEl.appendChild(cell);
  }
 }

 async function openDay(key){
  qBox.innerHTML="";
  if(!QUESTIONS[key]){qTitle.textContent="등록된 질문이 없습니다.";return;}
  const g=band(gradeSel.value);
  const qset=QUESTIONS[key].questions[g];
  qTitle.textContent=QUESTIONS[key].title;
  const user=auth.currentUser;
  const docId=`${user.uid}_${viewYear}_${key}`;
  const ref=doc(db,"entries",docId);
  const snap=await getDoc(ref);
  const prev=snap.exists()?snap.data():{};
  qset.forEach((q,i)=>{
   const p=document.createElement("p");p.textContent=`Q${i+1}. ${q}`;qBox.appendChild(p);
   const ta=document.createElement("textarea");ta.id=`a${i}`;ta.value=prev.answers?prev.answers[i]||"":"";qBox.appendChild(ta);
  });
  saveBtn.onclick=async()=>{
   const ans=[...qBox.querySelectorAll("textarea")].map(t=>t.value);
   await setDoc(ref,{year:viewYear,key,band:g,answers:ans,savedAt:new Date().toISOString()});
   alert("저장 완료!");
  };
 }

 renderCal();
});
</script>
</head>

<body>
<div id="loginView" class="card">
 <h1>온마음 성장일기</h1>
 <input id="userid" placeholder="아이디">
 <input id="password" type="password" placeholder="비밀번호">
 <button id="loginBtn">로그인</button>
 <button id="signupBtn" class="ghost">회원가입</button>
</div>

<div id="mainView" style="display:none;">
 <div class="grid">
  <div class="card">
   <h3>📅 달력</h3>
   <select id="yearSel"></select>
   <select id="monthSel"></select>
   <select id="gradeSel">
    <option value="1">1학년</option>
    <option value="2">2학년</option>
    <option value="3">3학년</option>
    <option value="4">4학년</option>
    <option value="5">5학년</option>
    <option value="6">6학년</option>
   </select>
   <div id="calendar" class="calendar"></div>
   <button id="logoutBtn" class="ghost">로그아웃</button>
  </div>
  <div class="card">
   <h3 id="qTitle">날짜를 선택하세요</h3>
   <div id="qBox"></div>
   <div class="divider"></div>
   <button id="saveBtn">저장</button>
  </div>
 </div>
</div>
</body>
</html>
