<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì˜¨ë§ˆìŒ ì„±ì¥ì¼ê¸° Â· í•™ìƒìš© MVP</title>
  <style>
    * { box-sizing: border-box; }
    :root {
      --bg:#fafafc; --card:#fff; --ink:#111; --muted:#6b7280;
      --accent:#2563eb; --ring:rgba(37,99,235,.25); --line:#e5e7eb;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--ink);
    }
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff 0%,rgba(255,255,255,.9) 60%,transparent);backdrop-filter:blur(8px);}
    .container{max-width:560px;margin:0 auto;padding:16px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .section{padding:16px;}
    .field{display:grid;gap:6px;margin-top:8px;}
    label{font-size:13px;color:var(--muted);}
    input,textarea,button{font:inherit;}
    input,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:10px;background:#fff;
    }
    input:focus,textarea:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 4px var(--ring);
    }
    button{
      padding:10px 14px;border-radius:10px;
      border:1px solid #d1d5db;background:#fff;cursor:pointer;
    }
    .btn{background:var(--accent);color:#fff;border-color:var(--accent);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .kicker{color:var(--muted);font-size:12px;}
    .divider{height:1px;background:var(--line);margin:12px 0;}
  </style>

  <!-- âœ… Firebase SDK (ëª¨ë“ˆ ë°©ì‹ ìµœì‹ ë²„ì „) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // ğŸ”¹ Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyCUvpi0A0Olc9t4Aamo6jCL5ZeKSppPmVM",
      authDomain: "haru-dc490.firebaseapp.com",
      databaseURL: "https://haru-dc490-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "haru-dc490",
      storageBucket: "haru-dc490.appspot.com",
      messagingSenderId: "1062975092523",
      appId: "1:1062975092523:web:3750d0e5722cae7767b76e",
      measurementId: "G-6VVS4MSJBT"
    };

    // ğŸ”¹ Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    console.log("âœ… Firebase initialized:", app.name);

    // ì „ì—­ ê³µìœ 
    window.auth = auth;
    window.db = db;

    // === ë¡œê·¸ì¸ ê´€ë ¨ ===
    const $ = (id) => document.getElementById(id);
    const authView = $('authView');
    const mainView = $('mainView');
    const uidEl = $('userid');
    const pwEl = $('password');
    const btnLogin = $('btnLogin');
    const btnSignup = $('btnSignup');
    const btnLogout = $('btnLogout');
    const questionEl = $('question');
    const answerEl = $('answer');
    const btnSave = $('btnSave');
    const statusEl = $('statusMsg');

    const QUESTIONS = [
      "ì˜¤ëŠ˜ í•˜ë£¨ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì¼ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?",
      "ì˜¤ëŠ˜ ë‚˜ëŠ” ì–´ë–¤ ê°ì •ì„ ëŠê¼ˆë‚˜ìš”?",
      "ë‚´ì¼ì˜ ë‚˜ì—ê²Œ í•´ì£¼ê³  ì‹¶ì€ í•œë§ˆë””ëŠ”?"
    ];

    // ì§ˆë¬¸ ëœë¤ í‘œì‹œ
    function loadQuestion() {
      const q = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
      questionEl.textContent = q;
    }

    // UI ì „í™˜
    function syncUI(user) {
      const loggedIn = !!user;
      authView.style.display = loggedIn ? 'none' : 'block';
      mainView.style.display = loggedIn ? 'block' : 'none';
      if (loggedIn) {
        loadQuestion();
        loadAnswer(user.uid);
      }
    }

    // Firestore ì €ì¥
    async function saveAnswer(uid, text) {
      const ref = doc(db, "onmind_diary", uid);
      await setDoc(ref, { text, updated: new Date() });
      statusEl.textContent = "ğŸ’¾ ì €ì¥ ì™„ë£Œ!";
    }

    // Firestore ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadAnswer(uid) {
      const ref = doc(db, "onmind_diary", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        answerEl.value = snap.data().text;
        statusEl.textContent = "ì´ì „ ë‹µë³€ ë¶ˆëŸ¬ì˜´.";
      } else {
        answerEl.value = "";
        statusEl.textContent = "ìƒˆ ì¼ê¸° ì‘ì„± ì‹œì‘.";
      }
    }

    // === ì´ë²¤íŠ¸ ===

    // íšŒì›ê°€ì…
    btnSignup.addEventListener('click', async () => {
      const uid = uidEl.value.trim(), pw = pwEl.value;
      if (!uid || !pw) return alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      try {
        const email = `${uid}@id.onmaum`;
        const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
        alert('íšŒì›ê°€ì… ì„±ê³µ!');
        syncUI(userCredential.user);
      } catch (e) {
        console.error(e);
        alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + e.message);
      }
    });

    // ë¡œê·¸ì¸
    btnLogin.addEventListener('click', async () => {
      const uid = uidEl.value.trim(), pw = pwEl.value;
      if (!uid || !pw) return alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      try {
        const email = `${uid}@id.onmaum`;
        const userCredential = await signInWithEmailAndPassword(auth, email, pw);
        alert('ë¡œê·¸ì¸ ì„±ê³µ!');
        syncUI(userCredential.user);
      } catch (e) {
        console.error(e);
        alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message);
      }
    });

    // ë¡œê·¸ì•„ì›ƒ
    btnLogout.addEventListener('click', async () => {
      await signOut(auth);
      alert('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
      syncUI(null);
    });

    // ë‹µë³€ ì €ì¥
    btnSave.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return alert("ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.");
      const text = answerEl.value.trim();
      await saveAnswer(user.uid, text);
    });

    // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
    onAuthStateChanged(auth, (user) => {
      syncUI(user);
      if (user) console.log("ìë™ ë¡œê·¸ì¸ ìœ ì§€:", user.email);
    });

    // âœ… ë¡œê·¸ì¸ í›„ ì¦‰ì‹œ UI ê°±ì‹  ê°•ì œ (í•µì‹¬ ìˆ˜ì •)
    syncUI(window.auth.currentUser);
  </script>
</head>

<body>
  <header>
    <div class="container">
      <h1>ì˜¨ë§ˆìŒ ì„±ì¥ì¼ê¸° Â· í•™ìƒìš© MVP</h1>
      <span class="kicker">íŠ¹ë³„í•œ í•˜ë£¨ Ã— SEL 5-Years Diary</span>
    </div>
  </header>

  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <section id="authView" class="container">
    <div class="card section">
      <h3>ë¡œê·¸ì¸</h3>
      <div class="field"><label>ì•„ì´ë””</label><input id="userid" placeholder="ì˜ˆ: s1234"></div>
      <div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
      <div class="field" style="margin-top:12px;display:flex;gap:8px;">
        <button id="btnLogin" class="btn" style="flex:1;">ë¡œê·¸ì¸</button>
        <button id="btnSignup" style="flex:1;">íšŒì›ê°€ì…</button>
      </div>
      <p class="kicker">Firebase Auth ì—°ë™ í…ŒìŠ¤íŠ¸ìš©</p>
    </div>
  </section>

  <!-- ë©”ì¸ í™”ë©´ -->
  <section id="mainView" class="container" style="display:none;">
    <div class="card section">
      <h3>ì˜¤ëŠ˜ì˜ ë§ˆìŒ ì§ˆë¬¸ ğŸ’­</h3>
      <p id="question" style="font-weight:600;"></p>
      <textarea id="answer" rows="6" placeholder="ì˜¤ëŠ˜ì˜ ìƒê°ì´ë‚˜ ê°ì •ì„ ì ì–´ë³´ì„¸ìš”."></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;">
        <button id="btnSave" class="btn" style="flex:1;">ì €ì¥</button>
        <button id="btnLogout" style="flex:1;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <p id="statusMsg" class="kicker" style="margin-top:8px;">ìƒíƒœ ë©”ì‹œì§€</p>
    </div>
  </section>
</body>
</html>
