<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>온마음 성장일기 · 학생용 MVP</title>
  <style>
    * { box-sizing: border-box; }
    :root {
      --bg:#fafafc; --card:#fff; --ink:#111; --muted:#6b7280;
      --accent:#2563eb; --ring:rgba(37,99,235,.25); --line:#e5e7eb;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--ink);
    }
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff 0%,rgba(255,255,255,.9) 60%,transparent);backdrop-filter:blur(8px);}
    .container{max-width:560px;margin:0 auto;padding:16px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .section{padding:16px;}
    .field{display:grid;gap:6px;margin-top:8px;}
    label{font-size:13px;color:var(--muted);}
    input,textarea,button{font:inherit;}
    input,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:10px;background:#fff;
    }
    input:focus,textarea:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 4px var(--ring);
    }
    button{
      padding:10px 14px;border-radius:10px;
      border:1px solid #d1d5db;background:#fff;cursor:pointer;
    }
    .btn{background:var(--accent);color:#fff;border-color:var(--accent);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .kicker{color:var(--muted);font-size:12px;}
    .divider{height:1px;background:var(--line);margin:12px 0;}
  </style>

  <!-- ✅ Firebase SDK (모듈 방식 최신버전) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // 🔹 Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCUvpi0A0Olc9t4Aamo6jCL5ZeKSppPmVM",
      authDomain: "haru-dc490.firebaseapp.com",
      databaseURL: "https://haru-dc490-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "haru-dc490",
      storageBucket: "haru-dc490.appspot.com",
      messagingSenderId: "1062975092523",
      appId: "1:1062975092523:web:3750d0e5722cae7767b76e",
      measurementId: "G-6VVS4MSJBT"
    };

    // 🔹 Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    console.log("✅ Firebase initialized:", app.name);

    // 전역 공유
    window.auth = auth;
    window.db = db;

    // === 로그인 관련 ===
    const $ = (id) => document.getElementById(id);
    const authView = $('authView');
    const mainView = $('mainView');
    const uidEl = $('userid');
    const pwEl = $('password');
    const btnLogin = $('btnLogin');
    const btnSignup = $('btnSignup');
    const btnLogout = $('btnLogout');
    const questionEl = $('question');
    const answerEl = $('answer');
    const btnSave = $('btnSave');
    const statusEl = $('statusMsg');

    const QUESTIONS = [
      "오늘 하루 가장 기억에 남는 일은 무엇이었나요?",
      "오늘 나는 어떤 감정을 느꼈나요?",
      "내일의 나에게 해주고 싶은 한마디는?"
    ];

    // 질문 랜덤 표시
    function loadQuestion() {
      const q = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
      questionEl.textContent = q;
    }

    // UI 전환
    function syncUI(user) {
      const loggedIn = !!user;
      authView.style.display = loggedIn ? 'none' : 'block';
      mainView.style.display = loggedIn ? 'block' : 'none';
      if (loggedIn) {
        loadQuestion();
        loadAnswer(user.uid);
      }
    }

    // Firestore 저장
    async function saveAnswer(uid, text) {
      const ref = doc(db, "onmind_diary", uid);
      await setDoc(ref, { text, updated: new Date() });
      statusEl.textContent = "💾 저장 완료!";
    }

    // Firestore 불러오기
    async function loadAnswer(uid) {
      const ref = doc(db, "onmind_diary", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        answerEl.value = snap.data().text;
        statusEl.textContent = "이전 답변 불러옴.";
      } else {
        answerEl.value = "";
        statusEl.textContent = "새 일기 작성 시작.";
      }
    }

    // === 이벤트 ===

    // 회원가입
    btnSignup.addEventListener('click', async () => {
      const uid = uidEl.value.trim(), pw = pwEl.value;
      if (!uid || !pw) return alert('아이디/비밀번호를 입력하세요.');
      try {
        const email = `${uid}@id.onmaum`;
        const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
        alert('회원가입 성공!');
        syncUI(userCredential.user);
      } catch (e) {
        console.error(e);
        alert('회원가입 실패: ' + e.message);
      }
    });

    // 로그인
    btnLogin.addEventListener('click', async () => {
      const uid = uidEl.value.trim(), pw = pwEl.value;
      if (!uid || !pw) return alert('아이디/비밀번호를 입력하세요.');
      try {
        const email = `${uid}@id.onmaum`;
        const userCredential = await signInWithEmailAndPassword(auth, email, pw);
        alert('로그인 성공!');
        syncUI(userCredential.user);
      } catch (e) {
        console.error(e);
        alert('로그인 실패: ' + e.message);
      }
    });

    // 로그아웃
    btnLogout.addEventListener('click', async () => {
      await signOut(auth);
      alert('로그아웃 완료');
      syncUI(null);
    });

    // 답변 저장
    btnSave.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return alert("로그인 상태가 아닙니다.");
      const text = answerEl.value.trim();
      await saveAnswer(user.uid, text);
    });

    // 로그인 상태 감지
    onAuthStateChanged(auth, (user) => {
      syncUI(user);
      if (user) console.log("자동 로그인 유지:", user.email);
    });

    // ✅ 로그인 후 즉시 UI 갱신 강제 (핵심 수정)
    syncUI(window.auth.currentUser);
  </script>
</head>

<body>
  <header>
    <div class="container">
      <h1>온마음 성장일기 · 학생용 MVP</h1>
      <span class="kicker">특별한 하루 × SEL 5-Years Diary</span>
    </div>
  </header>

  <!-- 로그인 화면 -->
  <section id="authView" class="container">
    <div class="card section">
      <h3>로그인</h3>
      <div class="field"><label>아이디</label><input id="userid" placeholder="예: s1234"></div>
      <div class="field"><label>비밀번호</label><input id="password" type="password" placeholder="비밀번호"></div>
      <div class="field" style="margin-top:12px;display:flex;gap:8px;">
        <button id="btnLogin" class="btn" style="flex:1;">로그인</button>
        <button id="btnSignup" style="flex:1;">회원가입</button>
      </div>
      <p class="kicker">Firebase Auth 연동 테스트용</p>
    </div>
  </section>

  <!-- 메인 화면 -->
  <section id="mainView" class="container" style="display:none;">
    <div class="card section">
      <h3>오늘의 마음 질문 💭</h3>
      <p id="question" style="font-weight:600;"></p>
      <textarea id="answer" rows="6" placeholder="오늘의 생각이나 감정을 적어보세요."></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;">
        <button id="btnSave" class="btn" style="flex:1;">저장</button>
        <button id="btnLogout" style="flex:1;">로그아웃</button>
      </div>
      <p id="statusMsg" class="kicker" style="margin-top:8px;">상태 메시지</p>
    </div>
  </section>
</body>
</html>
