<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>온마음 성장일기 · 학생용 MVP</title>
  <style>
    body {font-family: system-ui, "Noto Sans KR", sans-serif; background:#fafafc; margin:0; color:#111;}
    .container {max-width:560px; margin:0 auto; padding:16px;}
    .card {background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.05); padding:16px;}
    input, button {font:inherit;}
    input {width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;}
    button {padding:10px 14px; border:none; border-radius:8px; cursor:pointer;}
    .btn {background:#2563eb; color:#fff;}
    .btn:disabled {opacity:.6; cursor:not-allowed;}
    .kicker{color:#6b7280;font-size:12px;}
  </style>

  <!-- ✅ 옛날 방식 (CDN + firebase.initializeApp) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCUvpi0A0Olc9t4Aamo6jCL5ZeKSppPmVM",
      authDomain: "haru-dc490.firebaseapp.com",
      databaseURL: "https://haru-dc490-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "haru-dc490",
      storageBucket: "haru-dc490.appspot.com",
      messagingSenderId: "1062975092523",
      appId: "1:1062975092523:web:3750d0e5722cae7767b76e",
      measurementId: "G-6VVS4MSJBT"
    };

    firebase.initializeApp(firebaseConfig);
    console.log("✅ Firebase initialized:", firebase.apps.length);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const $ = (id) => document.getElementById(id);
    const authView = $("authView");
    const mainView = $("mainView");

    const QUESTIONS = [
      "오늘 가장 기억에 남는 일은 무엇인가요?",
      "오늘 내가 느낀 감정은?",
      "내일의 나에게 해주고 싶은 말은?"
    ];

    function syncUI(user) {
      if (user) {
        authView.style.display = "none";
        mainView.style.display = "block";
        loadQuestion();
        loadAnswer(user.uid);
      } else {
        authView.style.display = "block";
        mainView.style.display = "none";
      }
    }

    function loadQuestion() {
      const q = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
      $("question").textContent = q;
    }

    async function saveAnswer(uid, text) {
      await db.collection("onmind_diary").doc(uid).set({ text, updated: new Date() });
      $("statusMsg").textContent = "💾 저장 완료!";
    }

    async function loadAnswer(uid) {
      const docSnap = await db.collection("onmind_diary").doc(uid).get();
      if (docSnap.exists) {
        $("answer").value = docSnap.data().text;
        $("statusMsg").textContent = "이전 답변 불러옴.";
      } else {
        $("answer").value = "";
        $("statusMsg").textContent = "새 일기 작성 시작.";
      }
    }

    $("btnSignup").addEventListener("click", async () => {
      const uid = $("userid").value.trim();
      const pw = $("password").value;
      if (!uid || !pw) return alert("아이디와 비밀번호를 입력하세요.");
      try {
        const email = `${uid}@id.onmaum`;
        await auth.createUserWithEmailAndPassword(email, pw);
        alert("회원가입 성공!");
      } catch (e) {
        alert("회원가입 실패: " + e.message);
      }
    });

    $("btnLogin").addEventListener("click", async () => {
      const uid = $("userid").value.trim();
      const pw = $("password").value;
      if (!uid || !pw) return alert("아이디와 비밀번호를 입력하세요.");
      try {
        const email = `${uid}@id.onmaum`;
        await auth.signInWithEmailAndPassword(email, pw);
        alert("로그인 성공!");
      } catch (e) {
        alert("로그인 실패: " + e.message);
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await auth.signOut();
      alert("로그아웃 완료");
    });

    $("btnSave").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return alert("로그인 상태가 아닙니다.");
      const text = $("answer").value.trim();
      await saveAnswer(user.uid, text);
    });

    firebase.auth().onAuthStateChanged(syncUI);
  </script>
</head>

<body>
  <header>
    <div class="container">
      <h1>온마음 성장일기 · 학생용 MVP</h1>
      <span class="kicker">특별한 하루 × SEL 5-Years Diary</span>
    </div>
  </header>

  <section id="authView" class="container">
    <div class="card">
      <h3>로그인</h3>
      <div><label>아이디</label><input id="userid" placeholder="예: s1234"></div>
      <div><label>비밀번호</label><input id="password" type="password"></div>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button id="btnLogin" class="btn" style="flex:1;">로그인</button>
        <button id="btnSignup" style="flex:1;">회원가입</button>
      </div>
      <p class="kicker">Firebase Auth 연동 테스트</p>
    </div>
  </section>

  <section id="mainView" class="container" style="display:none;">
    <div class="card">
      <h3>오늘의 마음 질문 💭</h3>
      <p id="question" style="font-weight:600;"></p>
      <textarea id="answer" rows="6" placeholder="오늘의 생각이나 감정을 적어보세요."></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;">
        <button id="btnSave" class="btn" style="flex:1;">저장</button>
        <button id="btnLogout" style="flex:1;">로그아웃</button>
      </div>
      <p id="statusMsg" class="kicker" style="margin-top:8px;">상태 메시지</p>
    </div>
  </section>
</body>
</html>

