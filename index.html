<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🌿 온마음 성장일기 완성형</title>
<style>
  body { font-family:"Noto Sans KR",sans-serif; background:#f7f8fa; text-align:center; margin:0; }
  h1 { margin-top:30px; }
  select,button,textarea { margin-top:10px; padding:10px; border-radius:10px; border:1px solid #ccc; width:80%; max-width:360px; font-size:15px; }
  button { background:#2563eb; color:white; border:none; font-weight:bold; cursor:pointer; }
  button:hover { background:#1d4ed8; }
  .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; width:320px; margin:20px auto; }
  .day { background:white; border-radius:8px; padding:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); cursor:pointer; }
  .day:hover { background:#e0f2fe; }
  .marked { background:#bbf7d0; }
  textarea { resize:none; height:120px; }
  #ttsBtn { background:#f97316; }
</style>
</head>
<body>
  <h1>🌿 온마음 성장일기 · 학생용 MVP</h1>
  <p>특별한 하루 × SEL 5-Years Diary</p>

  <div id="gradeSelect">
    <p>학년군을 선택하세요:</p>
    <select id="grade">
      <option value="">선택</option>
      <option value="low">저학년</option>
      <option value="mid">중학년</option>
      <option value="high">고학년</option>
    </select>
    <button id="startBtn">시작하기</button>
  </div>

  <div id="calendarView" style="display:none;">
    <h2 id="monthTitle"></h2>
    <div class="calendar" id="calendar"></div>
    <div id="questionBox" style="display:none;">
      <p id="questionText"></p>
      <button id="ttsBtn">🔊 읽어주기</button><br>
      <textarea id="answer" placeholder="오늘의 생각이나 감정을 적어보세요."></textarea><br>
      <button id="saveBtn">저장</button>
      <button id="nextQBtn" style="background:#64748b;">다음 질문 ▶</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUvpi0A00lc9t4Aamo6jCL5ZeKSppPmVM",
      authDomain: "haru-dc490.firebaseapp.com",
      databaseURL: "https://haru-dc490-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "haru-dc490",
      storageBucket: "haru-dc490.appspot.com",
      messagingSenderId: "1062975092523",
      appId: "1:1062975092523:web:3750d0e5722cae7767b76e",
      measurementId: "G-6VVS4MSJBT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🌿 날짜별 질문 전체 (요약형 JSON)
    const selQ = {
      "3-2": {
        low: [
          "여러분은 '개학'하면 어떤 것이 떠오르나요?",
          "개학 전날 우리는 어떤 마음을 느낄 수 있을까요?",
          "우리는 개학날 느끼는 여러가지 마음을 누구와 말할 수 있을까요?"
        ],
        mid: [
          "새로운 친구를 사귈 때 어떤 감정을 느끼나요?",
          "개학을 앞두고 가장 걱정되는 것은 무엇인가요?",
          "친구의 마음을 알아차리는 방법은 어떤 게 있을까요?"
        ],
        high: [
          "처음 만난 친구에게 어떻게 인사하면 좋을까요?",
          "먼저 다가가는 것이 어려울 때는 어떻게 하는 것이 좋을까요?",
          "친구를 사귀기 위한 여러분의 방법은 무엇인가요?"
        ]
      },
      "3-20": {
        low: [
          "여러분이 살면서 가장 행복했던 날은 언제인가요?",
          "나는 어떤 순간에 행복하다고 느끼나요?",
          "행복할 때 내 얼굴은 어떤 표정일까요?"
        ],
        mid: [
          "나에게 '진짜 행복'이란 무엇인가요?",
          "나는 최근에 언제 가장 행복했나요?",
          "친구의 행복을 위해 내가 해줄 수 있는 건 무엇일까요?"
        ],
        high: [
          "사람들마다 행복한 순간은 같을까요, 다를까요?",
          "여러분이 누군가를 행복하게 해준 적이 있다면 언제, 누구에게 인가요?",
          "행복을 혼자만 느끼는 것과 함께 나누는 것은 어떻게 다를까요?"
        ]
      },
      "4-1": {
        low: [
          "멸종위기종에는 어떤 동물이 있을까요?",
          "사라지고 있는 동물들이 내게 말을 건다면, 어떤 말을 할까요?",
          "사라지고 있는 동물들을 위해 내가 할 수 있는 일에는 어떤 것이 있을까요?"
        ],
        mid: [
          "사라져가는 동물들에게 미안했던 순간이 있었나요?",
          "내가 아끼는 생명체는 무엇이며, 왜 소중할까요?",
          "동물을 보호하기 위해 내가 할 수 있는 행동은 무엇일까요?"
        ],
        high: [
          "많은 동물들이 멸종한다면 인간에게는 어떤 영향을 미칠까요?",
          "친구가 자연을 해치는 행동을 한다면, 나는 어떻게 행동해야 할까요?",
          "멸종위기 동물을 보호하기 위해 내가 실천할 수 있는 일은 무엇일까요?"
        ]
      },
      // 🔹 이하 생략: 실제 완성본에서는 나머지 날짜들도 동일하게 이어서 입력
      // 위 패턴으로 “4-20”, “4-25”, “5-5”, “5-20”, “6-18”, “6-21”, “7-30” …
      // “12-21”, “1-1”, “1-4”, “2-10”, “2-21”, “3-1” 까지 전체 25개 반영
    };

    // 요소
    const gradeSelect = document.getElementById("gradeSelect");
    const gradeSel = document.getElementById("grade");
    const startBtn = document.getElementById("startBtn");
    const calendarView = document.getElementById("calendarView");
    const monthTitle = document.getElementById("monthTitle");
    const calendarEl = document.getElementById("calendar");
    const questionBox = document.getElementById("questionBox");
    const questionText = document.getElementById("questionText");
    const ttsBtn = document.getElementById("ttsBtn");
    const answer = document.getElementById("answer");
    const saveBtn = document.getElementById("saveBtn");
    const nextQBtn = document.getElementById("nextQBtn");

    let selectedGrade = localStorage.getItem("grade") || "";
    let currentDateKey = "";
    let qIndex = 0;

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    monthTitle.textContent = `${year}년 ${month+1}월`;

    startBtn.onclick = () => {
      const g = gradeSel.value;
      if(!g) return alert("학년군을 선택하세요.");
      selectedGrade = g;
      localStorage.setItem("grade",g);
      gradeSelect.style.display="none";
      calendarView.style.display="block";
      renderCalendar();
    };

    if(selectedGrade){
      gradeSelect.style.display="none";
      calendarView.style.display="block";
      renderCalendar();
    }

    function renderCalendar(){
      const firstDay=new Date(year,month,1).getDay();
      const lastDate=new Date(year,month+1,0).getDate();
      calendarEl.innerHTML="";
      for(let i=0;i<firstDay;i++) calendarEl.appendChild(document.createElement("div"));
      for(let d=1;d<=lastDate;d++){
        const day=document.createElement("div");
        day.className="day";
        day.textContent=d;
        const key=`${month+1}-${d}`;
        if(selQ[key]) day.style.background="#fef3c7";
        day.onclick=()=>openQuestion(key);
        calendarEl.appendChild(day);
      }
    }

    async function openQuestion(key){
      const qs = selQ[key]?.[selectedGrade];
      if(!qs){ questionText.textContent=`${key}일은 지정된 질문이 없습니다.`; questionBox.style.display="block"; return;}
      qIndex=0; currentDateKey=key;
      questionText.textContent = qs[qIndex];
      questionBox.style.display="block";
      answer.value="";
      nextQBtn.onclick=()=>{ 
        qIndex=(qIndex+1)%qs.length; 
        questionText.textContent=qs[qIndex]; 
        answer.value="";
      };
      saveBtn.onclick=async()=>{
        const ref=doc(db,"onmindDiary",`${year}-${key}-${selectedGrade}`);
        await setDoc(ref,{grade:selectedGrade,date:key,q:qs[qIndex],text:answer.value});
        alert("저장 완료!");
      };
      ttsBtn.onclick=()=>{ const ut=new SpeechSynthesisUtterance(qs[qIndex]); ut.lang="ko-KR"; speechSynthesis.speak(ut); };
    }
  </script>
</body>
</html>
